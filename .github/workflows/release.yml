name: Release CI

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      # NOTE(20241016): this is a workaround for PR with head
      #   updated by gen_requirements_txt workflow
      - review_requested
      - assigned
  # allow manually triggering the build
  workflow_dispatch:

jobs:
  build_python_packages:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      OTACLIENT_WHL: ${{ steps.set_env.outputs.OTACLIENT_WHL }}
      OTACLIENT_VERSION: ${{ steps.set_env.outputs.OTACLIENT_VERSION }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          # use the minimum py ver we support to generate the wheel
          python-version: 3.8

      - name: install build deps
        run: |
          python -m pip install -U pip
          python -m pip install -U hatch

      - name: build otaclient package
        run: |
          hatch build -t wheel

      - name: set environment variables
        id: set_env
        run: |
          OTACLIENT_WHL=$(basename $(ls dist/otaclient-*.whl))
          OTACLIENT_VERSION=$(echo $OTACLIENT_WHL | sed -E 's/otaclient-([0-9]+\.[0-9]+(\.[0-9]+)?).*\.whl/\1/')
          echo OTACLIENT_WHL=${OTACLIENT_WHL} >> $GITHUB_OUTPUT
          echo OTACLIENT_VERSION=${OTACLIENT_VERSION} >> $GITHUB_OUTPUT

      - name: build otaclient service API python package
        run: |
          pushd proto
          hatch build -t wheel
          popd
          cp proto/dist/*.whl dist

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-python-packages
          path: dist/*.whl

  build_squashfs_image_x86_64:
    runs-on: ubuntu-latest
    needs: build_python_packages
    env:
      WHL: ${{ needs.build_python_packages.outputs.OTACLIENT_WHL }}
      VERSION: ${{ needs.build_python_packages.outputs.OTACLIENT_VERSION }}
      SQUASHFS: dist/ota-client-x86_64-v${{ needs.build_python_packages.outputs.OTACLIENT_VERSION }}.squashfs
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: build squashfs image for x86_64
        uses: ./.github/actions/build_squashfs_image
        with:
          platform: linux/amd64
          platform_suffix: x86_64
          base_image: ubuntu:22.04
          whl: ${WHL}
          version: ${VERSION}
          output_squashfs: ${SQUASHFS}

      - name: build patches
        uses: ./.github/actions/build_patches
        with:
          platform_suffix: x86_64
          version: ${VERSION}
          squashfs: ${SQUASHFS}
          output_dir: dist

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-squashfs_x86_64
          path: dist/*.squashfs

  build_squashfs_image_arm64:
    runs-on: ubuntu-latest
    needs: build_python_packages
    env:
      WHL: ${{ needs.build_python_packages.outputs.OTACLIENT_WHL }}
      VERSION: ${{ needs.build_python_packages.outputs.OTACLIENT_VERSION }}
      SQUASHFS: dist/ota-client-arm64-v${{ needs.build_python_packages.outputs.OTACLIENT_VERSION }}.squashfs
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: build squashfs image for arm64
        uses: ./.github/actions/build_squashfs_image
        with:
          platform: linux/arm64
          platform_suffix: arm64
          base_image: arm64v8/ubuntu:22.04
          whl: ${WHL}
          version: ${VERSION}
          output_squashfs: ${SQUASHFS}

      - name: build paches
        uses: ./.github/actions/build_patches
        with:
          platform_suffix: arm64
          version: ${VERSION}
          squashfs: ${SQUASHFS}
          output_dir: dist

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-squashfs_arm64
          path: |
            dist/*.squashfs
            dist/*.patch

  post_build:
    runs-on: ubuntu-latest
    needs: [build_python_packages, build_squashfs_image_x86_64, build_squashfs_image_arm64]
    steps:
      - name: download python packages artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts-python-packages
          path: dist

      - name: download squashfs x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts-squashfs_x86_64
          path: dist

      - name: download squashfs arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts-squashfs_arm64
          path: dist

      - name: generate json manifest
        uses: ./.github/actions/generate_manifest
        with:
          dir: dist
          output_manifest: dist/manifest.json

      - name: calculate checksum
        run: |
          for FILE in dist/*.{whl,squashfs,patch,json}; do
            sha256sum ${FILE} | sed -E "s@(\w+)\s+.*@sha256:\1@" > ${FILE}.checksum
          done

      - name: debug
        run: |
          ls -l dist
